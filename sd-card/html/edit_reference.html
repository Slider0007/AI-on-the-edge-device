<!DOCTYPE html>
<html lang="en" xml:lang="en"> 
<head>
    <meta charset="UTF-8">
    <title>Reference Image</title>
        
    <style>
        h1 {font-size: 1.8em;}
        h2 {font-size: 1.5em; margin-block-start: 0.0em; margin-block-end: 0.2em;}
        h3 {font-size: 1.2em;}
        p {font-size: 1em;}

        body, html {
            font-size: 100%;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        input[type=number] {
            width: 60px;
            margin-right: 10px;
            padding: 3px 5px;
            display: inline-block;
            border: 1px solid #ccc;
            font-size: 16px;
            vertical-align: middle;
        }

        select {
			min-width: 72px;
			max-width: 100%;
			padding: 3px 5px;
			display: inline-block;
			border: 1px solid #ccc;
			font-size: 1em; 
			margin-right: 10px;
			vertical-align: middle;
		}

		input:out-of-range {
			background-color: rgba(255, 0, 0, 0.25);
			border: 1px solid red;
        }

		input:invalid {
			background-color: rgba(255, 0, 0, 0.25);
			border: 1px solid red;
        }

        .button {
            padding: 5px 10px;
            width: 205px;
            font-size: 16px;
        }

        th, td {
            padding: 5px 5px 5px 0px;
            height: 28px;
        }

        .table {
            width: 660px;
            padding: 5px 5px 5px 0px;
            table-layout: fixed;
        }

        details {
            text-align: justify;
            font-size: 16px;
            margin-right: 10px;
        }

		.tooltip {
			position: relative;
			display: inline-block;
		}

		.tooltip .tooltiptext {
			visibility: hidden;
			min-width: 310px;
			max-width: 310px;
			width: 310px;
			background-color: #dfdfdf;
			padding-top: 5px;
			padding-bottom: 10px;
			padding-left: 10px;
			padding-right: 10px;
			border: solid black 1px; 
			position: absolute; /* Position the tooltip */
			z-index: 1;
			top: 100%;
			margin-left: -40px;
		}

		.tooltip:hover .tooltiptext {
			visibility: visible;
		}

		.tooltip .tooltiptext table {
			border-collapse: collapse;
		}

		.tooltip .tooltiptext table th, .tooltip .tooltiptext table td {
			border: 1px solid darkgray;
			padding: 5px;
		}

		.tooltip .tooltiptext h1 { /* Tooltip headline, e.g. parameter name */
			font-size: 1.5em;
			margin-top: 0.2em !important; 
			margin-bottom: 0.3em !important;
		}

		.tooltip .tooltiptext h2 { /* Tooltip sub-headline, e.g. description*/
			font-size: 1.2em;
			margin-top: 1em !important; 
			margin-bottom: 0.3em !important;
		}

		.tooltip .tooltiptext h3 { 
			font-size: 1.05em;
			margin-top: 1em !important; 
			margin-bottom: 0.3em !important;
		}

		.tooltip .tooltiptext h4 { 
			font-size: 0.83em;
			margin-top: 1em !important; 
			margin-bottom: 0.3em !important;
		}

		.tooltip .tooltiptext p {
			margin-top: 0.3em !important; 
			margin-bottom: 0.3em !important;
		}

		.tooltip-content {
			width: calc(100% - 2px);
			height: calc(100% - 2px);
			padding: 1px;
		}
    </style>

    <link rel="stylesheet" href="mkdocs_theme.css?v=$COMMIT_HASH">
    <link rel="stylesheet" href="mkdocs_theme_extra.css?v=$COMMIT_HASH">
    <script src="jquery-3.6.0.min.js?v=$COMMIT_HASH"></script>
    <link href="firework.css?v=$COMMIT_HASH" rel="stylesheet">
    <script src="firework.js?v=$COMMIT_HASH"></script>
</head>

<body style="font-family: arial; padding: 0px 10px; width:660px; max-width:660px;">
    <h2>Reference Image</h2>
    <details id="desc_details">
        <summary><b>CLICK HERE</b> for usage description. Further documentation: 
                <a href=https://jomjol.github.io/AI-on-the-edge-device-docs/Reference-Image/ target=_blank>Reference Image</a>
        </summary>
        <p>
            The reference image is the base image on which the alignment marker, digit ROIs and analog ROIs will be defined.
        </p>        
        <p>
            Firstly the actual saved reference image is shown. If you start with the setup from scratch a default image is shown
            as placeholder. Use the button <b>"Create New Reference"</b> to start creation of your own reference image. After
            selecting the button a new image will be taken and all configured parameter will be applied to the shown image.
            With the button <b>"Update Image"</b> you can update the image again (still all parameter get applied to the new image).
        </p>        
        <p>
            To have reliable evaluation processing a properly horizontal aligned evaluation area is mandatory. Using the parameter
            "Rotation angle" and "Rotation angle (Fine-tune)" the image can be rotated in both directions. The resulting rotation
            angle is used to prerotate the image before the alignment algorithm is processed to compensate only small misalignments.
        </p>
        <p>
            After setting up your reference image don't forget to save the new configuration  with the button <b>"Save And Apply"</b>.  
            The new configuration gets automatically applied. No reboot is required.
        </p>
    </details>
    <hr>

	<table class="table">
        <colgroup>
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
        </colgroup>
        <tr>
            <td><input class="button" type="button" value="Show Actual Reference" onclick="showReference()"></td>	  
            <td><input class="button" type="button" id="createreference" value="Create New Reference" onclick="loadRawImage(false)"></td>
        </tr>
    </table>
    <table class="table">
        <colgroup>
            <col span="1" style="width: 5%;">
            <col span="1" style="width: 20%;">
            <col span="1" style="width: 28%;">
            <col span="1" style="width: 5%;">
            <col span="1" style="width: 20%;">
            <col span="1" style="width: 21%;">
        </colgroup>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Zoom</td>
            <td><label for="TakeImage_Zoom_value1" id="TakeImage_Zoom_text">Digital Zoom</label></td>
            <td><input class="camParameter" type="checkbox" id="TakeImage_Zoom_value1" name="TakeImage_Zoom"
                            onchange='setEnabled("TakeImage_Zoom_parameter", this.checked ? true : false);'></td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Brightness</td>
            <td>
                <span id="TakeImage_Brightness_text" style="color:black;">Brightness</span>
            </td>
            <td>
                <input class="camParameter" style="clear: both; width: 80%;vertical-align:middle" type="range" id="TakeImage_Brightness_value1" 
                        value=0 min="-2" max="2" onchange="this.nextElementSibling.value = this.value">
                <output id="TakeImage_Brightness_value1_output" style="vertical-align:middle; 
                                min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_ZoomMode</td>
            <td>
                <span id="TakeImage_ZoomMode_text">Zoom Mode</span>
            </td>
            <td class="camParameter TakeImage_Zoom_parameter">
				<select id="TakeImage_ZoomMode_value1">
					<option value="0" selected>Crop</option>
					<option value="1">Scale & Crop</option>
				</select>
            </td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Contrast</td>
            <td>
                <span id="TakeImage_Contrast_text" style="color:black;">Contrast</span>
            </td>
            <td>
                <input class="camParameter" style="clear: both; width: 80%;vertical-align:middle" type="range" id="TakeImage_Contrast_value1"
                        value=0 min="-2" max="2" onchange="this.nextElementSibling.value = this.value">
                <output id="TakeImage_Contrast_value1_output" style="vertical-align:middle; 
                                min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_ZoomOffsetX</td>
            <td>
                <span id="TakeImage_ZoomOffsetX_text">Zoom Offset X</span>
            </td>
            <td  class="camParameter TakeImage_Zoom_parameter">
                <input required style="clear: both" type="number" id="TakeImage_ZoomOffsetX_value1" value="0"  min="0" max="960" 
                        oninput="(!validity.rangeOverflow||(value=960)) && (!validity.rangeUnderflow||(value=0)) && 
                        (!validity.stepMismatch||(value=parseInt(this.value)));">px
            </td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Saturation</td>
            <td>
                <span id="TakeImage_Saturation_text" style="color:black;">Saturation</span>
            </td>
            <td>
                <input class="camParameter" style="clear: both; width: 80%;vertical-align:middle" type="range" id="TakeImage_Saturation_value1"
                        value=0 min="-2" max="2" onchange="this.nextElementSibling.value = this.value">
                <output id="TakeImage_Saturation_value1_output" style="vertical-align:middle; 
                                min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_ZoomOffsetY</td>
            <td>
                <span id="TakeImage_ZoomOffsetY_text">Zoom Offset Y</span>
            </td>
            <td class="camParameter TakeImage_Zoom_parameter">
                <input required style="clear: both" type="number" id="TakeImage_ZoomOffsetY_value1" value="0"  min="0" max="720" 
                        oninput="(!validity.rangeOverflow||(value=720)) && (!validity.rangeUnderflow||(value=0)) && 
                        (!validity.stepMismatch||(value=parseInt(this.value)));">px
            </td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Sharpness</td>
            <td>
                <span id="TakeImage_Sharpness_text">Sharpness</span>
            </td>
            <td>
                <input class="camParameter" style="clear: both; width: 80%;vertical-align:middle" type="range" id="TakeImage_Sharpness_value1"
                        value=0 min="-4" max="3" onchange="onchangeSharpness(this.value);">
                <output id="TakeImage_Sharpness_value1_output" style="vertical-align:middle; 
                        min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_AutoExposureLevel</td>
            <td style="padding:0px 5px 0px 0px">
                <span id="TakeImage_AutoExposureLevel_text">Auto Exposure Level</span>
            </td>
            <td>
                <input class="camParameter" style="clear: both; width: 80%;vertical-align:middle" 
                        type="range" id="TakeImage_AutoExposureLevel_value1" value=0 min="-2" max="2" 
                        onchange="this.nextElementSibling.value = this.value">
                <output id="TakeImage_AutoExposureLevel_value1_output" style="vertical-align:middle; 
                                min-width:15px; padding-right:5px; text-align:right; float:left">0</output>
            </td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_MirrorHorizontal</td>
            <td><label for="TakeImage_MirrorHorizontal_value1" id="TakeImage_MirrorHorizontal_text">Mirror Horizontal</label></td>
            <td><input class="camParameter" type="checkbox" id="TakeImage_MirrorHorizontal_value1" name="TakeImage_MirrorHorizontal" value="1" ></td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Aec2Algo</td>
            <td style="padding:0px 5px 0px 0px"><label for="TakeImage_Aec2Algo_value1" id="TakeImage_Aec2Algo_text">Auto Exposure Control 2 Algo</label></td>
            <td><input class="camParameter" type="checkbox" id="TakeImage_Aec2Algo_value1" name="TakeImage_Aec2Algo" value="1"></td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_FlipVertical</td>
            <td><label for="TakeImage_FlipVertical_value1" id="TakeImage_FlipVertical_text">Flip Vertical</label></td>
            <td><input class="camParameter" type="checkbox" id="TakeImage_FlipVertical_value1" name="TakeImage_FlipVertical" value="1" ></td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Grayscale</td>
            <td><label for="TakeImage_Grayscale_value1" id="TakeImage_Grayscale_text">Grayscale</label></td>
            <td><input class="camParameter" type="checkbox" id="TakeImage_Grayscale_value1" name="TakeImage_Grayscale" value="1"></td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_Alignment_FlipImageSize</td>
            <td><label for="Alignment_FlipImageSize_value1" id="Alignment_FlipImageSize_text">Flip Image Size</label></td>
            <td><input class="camParameter" type="checkbox" id="Alignment_FlipImageSize_value1" name="Alignment_FlipImageSize" value="1"></td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_Negative</td>
            <td><label for="TakeImage_Negative_value1" id="TakeImage_Negative_text">Negative</label></td>
            <td><input class="camParameter" type="checkbox" id="TakeImage_Negative_value1" name="TakeImage_Negative" value="1"></td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_Alignment_InitialRotate</td>
            <td><label for="Alignment_InitialRotate_value1" name="Alignment_InitialRotate_text">Rotation Angle</label></td>	  
            <td>
                <input class="camParameter" required type="number" id="Alignment_InitialRotate_value1" name="Alignment_InitialRotate" 
                        value="0" min="-360" max="360" onchange="drawRotated()" oninput="(!validity.rangeOverflow||(value=360)) 
                        && (!validity.rangeUnderflow||(value=-360)) && (!validity.stepMismatch||(value=parseInt(this.value)));">°
            </td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_WaitBeforeTakingPicture</td>		
            <td>
                <span id="TakeImage_WaitBeforeTakingPicture_text">Flash Time</span>
            </td>
            <td>
                <input class="camParameter" required type="number" id="TakeImage_WaitBeforeTakingPicture_value1" 
                        value="2.0" min="0.1" step="0.1" oninput="(!validity.rangeUnderflow||(value=0.1));">s
            </td>
        </tr>
        <tr>
            <td style="overflow:hidden">$TOOLTIP_Alignment_InitialRotate</td>
            <td style="padding:0px 5px 0px 0px"><label for="Alignment_InitialRotate_value1_fine" 
                    name="Alignment_InitialRotate_text">Rotation Angle<br>(Fine-tune)</label></td>	
            <td>
                <input class="camParameter" required type="number" id="Alignment_InitialRotate_value1_fine" name="Alignment_InitialRotate" 
                        value=0.0 min="-1" max="1" step="0.1" onchange="drawRotated()" oninput="(!validity.rangeOverflow||(value=1)) && 
                        (!validity.rangeUnderflow||(value=-1)) && (!validity.stepMismatch||(value=parseInt(this.value)));">°
            </td>
            <td style="overflow:hidden">$TOOLTIP_TakeImage_LEDIntensity</td>
            <td>
                <span id="TakeImage_LEDIntensity_text" style="color:black;">Flash Intensity</span>
            </td>
            <td>
                <input class="camParameter" required style="clear: both" type="number" id="TakeImage_LEDIntensity_value1" 
                        value="0" min="0" max="100" oninput="(!validity.rangeOverflow||(value=100)) && 
                        (!validity.rangeUnderflow||(value=0)) && (!validity.stepMismatch||(value=parseInt(this.value)));">%
            </td>
        </tr>
    </table>
    <table class="table">
        <colgroup>
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
            <col span="1" style="width: 33.3%;">
        </colgroup>
        <tr>
            <td style="vertical-align: bottom;"><b>Reference Image</b></td>
            <td><input class="button" type="button" id="take" onclick="doTake(true)" value="Update Image">
            <td>
                <input style="font-weight:bold;" class="button" type="button" id="savereference" 
                        value="Save And Apply" onclick="SaveReference()">
            </td>
        </tr>
        <tr>
            <td colspan="3"><canvas style="max-width: 100%" id="canvas"></canvas></td>
        </tr>	
    </table>


<script src="common.js?v=$COMMIT_HASH"></script> 
<script src="readconfigcommon.js?v=$COMMIT_HASH"></script>  
<script src="readconfigparam.js?v=$COMMIT_HASH"></script>  
<script>
    let canvas = document.getElementById('canvas'),
        context = canvas.getContext('2d'),
        imageObj = new Image(),  
        isActReference = false,
        paramLocal = {},
        initialConfigUrl = "";


    function onchangeSharpness(val)
    {
        if (val > -4) // 3 .. -3
            document.getElementById('TakeImage_Sharpness_value1_output').value = val;
        else if (val == -4) // Automatic
            document.getElementById('TakeImage_Sharpness_value1_output').value = "A";
    }
    
    
    function restoreCamSettings()
    {
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
                if (this.status >= 200 && this.status < 300) {
                    // Nothing do do
                }
                else {
                    document.getElementById("createreference").disabled = false;
                    firework.launch("Camera image parameter reset failed (Response status: " + this.status + 
                                    "). Repeat action or check logs.", 'danger', 30000);
                    console.error("Camera image parameter reset failed. Response status: " + this.status);
                }
            }
        };

        xhttp.timeout = 10000;  // 10 seconds
        xhttp.open("GET", initialConfigUrl, true);
        xhttp.send();
    }
    

    function doTake(release_save = false)
    { 
        firework.launch('Taking image...', 'success', 250, true);

        if (release_save)
            document.getElementById("savereference").disabled = false;

        let url = "";

        if (paramLocal["TakeImage"]["Brightness"].found && paramLocal["TakeImage"]["Brightness"].enabled) // Parameter available?
        {
            let flashtime = document.getElementById("TakeImage_WaitBeforeTakingPicture_value1").value;
            if (flashtime == "") flashtime = "2.0";
            let flashintensity = document.getElementById("TakeImage_LEDIntensity_value1").value;
            if (flashintensity == "") flashintensity = "50";
            let brightness = document.getElementById("TakeImage_Brightness_value1").value;
            if (brightness == "") brightness = "0";
            let contrast = document.getElementById("TakeImage_Contrast_value1").value;
            if (contrast == "") contrast = "0";
            let saturation = document.getElementById("TakeImage_Saturation_value1").value;
            if (saturation == "") saturation = "0";
            let sharpness = document.getElementById("TakeImage_Sharpness_value1").value;
            if (sharpness == "") sharpness = "0";
            let autoExposureLevel = document.getElementById("TakeImage_AutoExposureLevel_value1").value;
            if (autoExposureLevel == "") autoExposureLevel = "0";
            let aec2 = document.getElementById("TakeImage_Aec2Algo_value1").checked ? "true" : "false";
            if (aec2 == "") aec2 = "false";
            let grayscale = document.getElementById("TakeImage_Grayscale_value1").checked ? "true" : "false";
            if (grayscale == "") grayscale = "false";
            let negative = document.getElementById("TakeImage_Negative_value1").checked ? "true" : "false";
            if (negative == "") negative = "false";
            let mirror = document.getElementById("TakeImage_MirrorHorizontal_value1").checked ? "true" : "false";
            if (mirror == "") mirror = "false";
            let flip = document.getElementById("TakeImage_FlipVertical_value1").checked ? "true" : "false";
            if (flip == "") flip = "false";
            let zoom = document.getElementById("TakeImage_Zoom_value1").checked ? "true" : "false";
            if (zoom == "") zoom = "false";

            url = getDomainname() + "/camera?task=set_parameter&flashtime=" + flashtime + "&flashintensity=" + flashintensity + 
                    "&brightness=" + brightness + "&contrast=" + contrast + "&saturation=" + saturation + "&sharpness=" + sharpness + 
                    "&autoexposurelevel=" + autoExposureLevel + "&aec2=" + aec2 + "&grayscale=" + grayscale + "&negative=" + negative + 
                    "&mirror=" + mirror + "&flip=" + flip + "&zoom=" + zoom;
            
            if (zoom == "true") {
                let zoommode = document.getElementById("TakeImage_ZoomMode_value1").value;
                if (zoommode == "") zoommode = "0";
                let zoomOffsetX = document.getElementById("TakeImage_ZoomOffsetX_value1").value;
                if (zoomOffsetX == "") zoomOffsetX = "0";
                let zoomOffsetY = document.getElementById("TakeImage_ZoomOffsetY_value1").value;
                if (zoomOffsetX == "") zoomOffsetX = "0";

                url += "&zoommode=" + zoommode + "&zoomx=" + zoomOffsetX + "&zoomy=" + zoomOffsetY;
            }
        }
        else {
            firework.launch('Parsing of parameter failed', 'danger', 30000);
            return;
        }

        if (initialConfigUrl == "")
            initialConfigUrl = url;

        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
                if (this.status >= 200 && this.status < 300) {
                    loadRawImage(true);
                }
                else if (this.status == 403) {
                    document.getElementById("createreference").disabled = false;
                    firework.launch("Take reference image parameter setting rejected. Process not (yet) initialized. \
                                        Repeat action or check logs.", 'warning', 5000);
                    console.error("Take reference image parameter setting rejected. Process not (yet) initialized. \
                                        Response status: " + this.status);
                }
                else {
                    document.getElementById("createreference").disabled = false;
                    firework.launch("Take reference image parameter setting failed (Response status: " + this.status + 
                                    "). Repeat action or check logs.", 'danger', 30000);
                    console.error("Take reference image parameter setting failed. Response status: " + this.status);
                }
            }
        };

        xhttp.timeout = 10000;  // 10 seconds
        xhttp.open("GET", url, true);
        xhttp.send();
    }


    function loadRawImage(new_image)
    {
        if (new_image) {
            let url = getDomainname() + "/img_tmp/raw.jpg?" + Math.floor((Math.random() * 1000000) + 1);
            loadCanvas(url, true);     
            isActReference = false;
        }
        else {
            document.getElementById("createreference").disabled = true;
            document.getElementById("savereference").disabled = true;
            document.getElementById("take").disabled = false;
            setEnabled("camParameter", true); // Release input for all camera parameter
            setEnabled("TakeImage_Zoom_parameter", paramLocal["TakeImage"]["Zoom"]["value1"] == "true" ? true : false); 
            doTake();
        }
    }
    

    function showReference()
    {
        let url = getDomainname() + "/fileserver/config/reference.jpg?" + Math.floor((Math.random() * 1000000) + 1);                              
        loadCanvas(url, false);
        isActReference = true;

        document.getElementById("savereference").disabled = true;
        document.getElementById("createreference").disabled = false;
        document.getElementById("take").disabled = true;
        setEnabled("camParameter", false); // Lock input for all camera parameter

        parseActualData();
    }


    function parseActualData()
    {
        WriteParameter(paramLocal, "TakeImage", "WaitBeforeTakingPicture");
        WriteParameter(paramLocal, "TakeImage", "LEDIntensity");
        WriteParameter(paramLocal, "TakeImage", "Brightness", true);		
        WriteParameter(paramLocal, "TakeImage", "Contrast", true);		
        WriteParameter(paramLocal, "TakeImage", "Saturation", true);
        WriteParameter(paramLocal, "TakeImage", "Sharpness", true);
        onchangeSharpness(paramLocal["TakeImage"]["Sharpness"]["value1"]); // -4 -> Auto
        WriteParameter(paramLocal, "TakeImage", "AutoExposureLevel", true);
        WriteParameter(paramLocal, "TakeImage", "Aec2Algo");
        WriteParameter(paramLocal, "TakeImage", "Grayscale");
        WriteParameter(paramLocal, "TakeImage", "Negative");
        WriteParameter(paramLocal, "TakeImage", "MirrorHorizontal");
        WriteParameter(paramLocal, "TakeImage", "FlipVertical");
        WriteParameter(paramLocal, "TakeImage", "Zoom");
        WriteParameter(paramLocal, "TakeImage", "ZoomMode");
        WriteParameter(paramLocal, "TakeImage", "ZoomOffsetX");
        WriteParameter(paramLocal, "TakeImage", "ZoomOffsetY");

        WriteParameter(paramLocal, "Alignment", "FlipImageSize");

        if (paramLocal["Alignment"]["InitialRotate"].value1 < 0) {
            document.getElementById("Alignment_InitialRotate_value1").value = Math.ceil(paramLocal["Alignment"]["InitialRotate"].value1);
        }
        else {
            document.getElementById("Alignment_InitialRotate_value1").value = Math.floor(paramLocal["Alignment"]["InitialRotate"].value1);
        }

        document.getElementById("Alignment_InitialRotate_value1_fine").value = (Number(paramLocal["Alignment"]["InitialRotate"].value1) - 
                                                        Number(document.getElementById("Alignment_InitialRotate_value1").value)).toFixed(1);
    }
    

    /* Parse parameter out of param structure and preset WebUI fields */
    function WriteParameter(_param, _cat, _name, outval = false)
    {
        if (_param[_cat][_name]["found"]) {
            document.getElementById(_cat+"_"+_name+"_text").style="color:black;"

            let el = document.getElementById(_cat+"_"+_name+"_value1");
            if (el.type == "select") {
                let textToFind = _param[_cat][_name]["value1"];
                let dd = document.getElementById(_cat+"_"+_name+"_value1");
                for (let i = 0; i < dd.options.length; i++) {
                    if (dd.options[i].text.toLowerCase() === textToFind.toLowerCase()) {
                        dd.selectedIndex = i;
                        break;
                    }
                }
            }
            else if (el.type == "checkbox") {
                document.getElementById(_cat+"_"+_name+"_value1").checked = paramLocal[_cat][_name]["value1"] == "true" ? true : false;
            }
            else {
                document.getElementById(_cat+"_"+_name+"_value1").value = _param[_cat][_name]["value1"];
            }

            if (outval)
                document.getElementById(_cat+"_"+_name+"_value1_output").value = document.getElementById(_cat+"_"+_name+"_value1").value;
        }
        else {
            document.getElementById(_cat+"_"+_name+"_text").style="color:lightgrey;"
            document.getElementById(_cat+"_"+_name).style="color:lightgrey;"		
        }
    }


    /* read WebUI fields and write parameter to param structure */
    function ReadParameter(_param, _cat, _name)
    {
        if (_param[_cat][_name]["found"]) {
            let el = document.getElementById(_cat+"_"+_name+"_value1");
            if (el.type == "select") {
                let sel = document.getElementById(_cat+"_"+_name+"_value1");
                _param[_cat][_name]["value1"] = sel.options[sel.selectedIndex].text;
            }
            else if (el.type == "checkbox") {
                paramLocal[_cat][_name]["value1"] = document.getElementById(_cat+"_"+_name+"_value1").checked ? "true" : "false";
            }
            else {
                _param[_cat][_name]["value1"] = document.getElementById(_cat+"_"+_name+"_value1").value;
            }
        }
    }


    function setEnabled(className, enabled)
    {       
        let _color = "rgb(122, 122, 122)";
		if (enabled) {
			_color = "black";
		}

		let elements = document.getElementsByClassName(className);
		for (i = 0; i < elements.length; i++) {
			if (enabled) {
				elements[i].classList.remove("disabled");
				elements[i].disabled = false;
			} 
            else {
				elements[i].classList.add("disabled");
				elements[i].disabled = true;
			}

			let inputs = elements[i].getElementsByTagName("input");
			for (j = 0; j < inputs.length; j++) {
				inputs[j].style.color = _color;
				if (enabled)
					inputs[j].removeAttribute("disabled");
                else
					inputs[j].setAttribute("disabled", "disabled");
			}

			let select = elements[i].getElementsByTagName("select");
			for (j = 0; j < select.length; j++) {
					select[j].style.color = _color;
				if (enabled)
					select[j].removeAttribute("disabled");
                else
					select[j].setAttribute("disabled", "disabled");
			}
		}
	}


    function ImageSizeValidation()
    {
        if (paramLocal["TakeImage"]["ImageSize"]["value1"] == "QVGA") {
            if (document.getElementById("Alignment_FlipImageSize_value1").checked ? false : true) {
                configuredWidth = 320;
            }
            else {
                configuredWidth = 240;
            }
        }
        else if (paramLocal["TakeImage"]["ImageSize"]["value1"] == "VGA") {
            if (document.getElementById("Alignment_FlipImageSize_value1").checked ? false : true) {
                configuredWidth = 640;
            }
            else {
                configuredWidth = 480;
            }
        }
        else {
            firework.launch('Unknown image size. No reference image size validation', 'danger', 30000);
            return;
        }

        if (configuredWidth != canvas.width) {
                firework.launch('Actual reference image size differs to configured image size. \
                    Please create a new reference image and redo alignment marker and ROI configuration', 'warning', 10000);
        }
    }


    function drawRotated(_grid = true, _applySpecials = false)
    {
        /* Handle rotation */
        let finerot= parseFloat(document.getElementById("Alignment_InitialRotate_value1_fine").value);
        let prerot = parseFloat(document.getElementById("Alignment_InitialRotate_value1").value);

        if (finerot == 1) {
            prerot +=1
            finerot = 0
        }

        if (finerot == -1) {
            prerot -=1
            finerot = 0
        }

        document.getElementById("Alignment_InitialRotate_value1_fine").value =  finerot;
        document.getElementById("Alignment_InitialRotate_value1").value =  prerot;
        let degrees = finerot + prerot;

       if (_applySpecials) {
            // Handle flip
            let flipImageSize = document.getElementById("Alignment_FlipImageSize_value1").checked;

            if (flipImageSize) {
                canvas.width = imageObj.height;
                canvas.height = imageObj.width;
            }
            else {
                canvas.width = imageObj.width;
                canvas.height = imageObj.height;
            }
        }

        context.fillStyle = "white";
        context.clearRect(0,0,canvas.width,canvas.height);
        context.save();

        if (isActReference) {
            context.drawImage(imageObj,0,0);
        }
        else {
            context.translate(canvas.width/2,canvas.height/2);
            context.rotate(degrees*Math.PI/180);

            context.drawImage(imageObj,-imageObj.width/2,-imageObj.height/2);
        }
        
        context.restore();

        if (_grid)
            drawGrid();
    }


    function drawGrid()
    {
        let w = canvas.width;
        let h = canvas.height;

        context.save();
        context.lineWidth = 0.25;
        context.strokeStyle = 'rgb(0, 153, 0)'; //'#00FF00';

        for (let i = h/2; i < h; i += 100) {
            context.moveTo(0, i);
            context.lineTo(w, i);
            context.stroke();
            context.moveTo(0, h-i);
            context.lineTo(w, h-i);
            context.stroke();
        }

        for (let i = w/2; i < w; i += 100) {
            context.moveTo(i, 0);
            context.lineTo(i, h);
            context.stroke();
            context.moveTo(w-i, 0);
            context.lineTo(w-i, h);
            context.stroke();
        }

        context.restore();
    }


    function loadCanvas(dataURL, grid)
    {
        imageObj.onload = function() {
            canvas.width = this.width;
            canvas.height = this.height;

            if (grid)
                drawRotated(true, true);
            else
                drawRotated(false);

            ImageSizeValidation();

            if (initialConfigUrl !="")
                restoreCamSettings();
        };

        imageObj.src = loadImage(dataURL, 'img_not_available.png?v=$COMMIT_HASH').src;
    }


    function getCoords(elem) // crossbrowser version
    {
        let box = elem.getBoundingClientRect();
        let body = document.body;
        let docEl = document.documentElement;
        let scrollTop = window.pageYOffset || docEl.scrollTop || body.scrollTop;
        let scrollLeft = window.pageXOffset || docEl.scrollLeft || body.scrollLeft;
        let clientTop = docEl.clientTop || body.clientTop || 0;
        let clientLeft = docEl.clientLeft || body.clientLeft || 0;
        let top  = box.top + scrollTop - clientTop;
        let left = box.left + scrollLeft - clientLeft;
        return { top: Math.round(top), left: Math.round(left) };
    }


    function mouseMove(e)
    {
        if (isActReference)
            drawRotated(false);
        else
            drawRotated(true);

        let zw = getCoords(this);
        let x = e.pageX - zw.left;
        let y = e.pageY - zw.top;
        
        context.lineWidth = 1;
        context.strokeStyle = 'rgb(0, 255, 0)'; //"#00FF00";
        context.beginPath(); 
        context.moveTo(0,y);
        context.lineTo(canvas.width, y);
        context.moveTo(x, 0);
        context.lineTo(x, canvas.height);
        context.stroke();
    }


    function SaveReference()
    {
        if (confirm("Are you sure you want to save and apply the new camera configuration and reference image?")) {
            document.getElementById("savereference").disabled = true;

            ReadParameter(param, "TakeImage", "WaitBeforeTakingPicture");
            ReadParameter(param, "TakeImage", "LEDIntensity");
            ReadParameter(param, "TakeImage", "Brightness");		
            ReadParameter(param, "TakeImage", "Contrast");
            ReadParameter(param, "TakeImage", "Saturation");
            ReadParameter(param, "TakeImage", "Sharpness");
            ReadParameter(param, "TakeImage", "AutoExposureLevel");
            ReadParameter(param, "TakeImage", "Aec2Algo");
            ReadParameter(param, "TakeImage", "Grayscale");
            ReadParameter(param, "TakeImage", "Negative");

            ReadParameter(param, "TakeImage", "MirrorHorizontal");
            ReadParameter(param, "TakeImage", "FlipVertical");

            ReadParameter(param, "TakeImage", "Zoom");
            ReadParameter(param, "TakeImage", "ZoomMode");
            ReadParameter(param, "TakeImage", "ZoomOffsetX");
            ReadParameter(param, "TakeImage", "ZoomOffsetY");

            ReadParameter(param, "Alignment", "FlipImageSize");
            
            param["Alignment"]["InitialRotate"].value1 = (Number(document.getElementById("Alignment_InitialRotate_value1").value) + 
                                                            Number(document.getElementById("Alignment_InitialRotate_value1_fine").value)).toFixed(1);

            drawRotated(false);

            WriteConfigININew();
            SaveConfigToServer(getDomainname());
            SaveCanvasToImage(canvas, "/config/reference.jpg", true, getDomainname());
            showReference();

            firework.launch('Save and apply configuration...', 'success', 2000, true);
            setTimeout(function() {
                reload_config();
            }, 200);
        }
    }


    /* hash #description open the details part of the page */
    function openDescription()
    {
        if(window.location.hash) {
            let hash = window.location.hash.substring(1); //Puts hash in variable, and removes the # character
            if(hash == 'description')
                document.getElementById("desc_details").open = true;
        }
    }


    function loadConfigData()
    {
        ParseConfig();
        paramLocal = getConfigParameters();
        showReference();
    }


    function init()
    {
        openDescription();
        
        canvas.addEventListener('mousemove', mouseMove, false);
        loadConfig().then(() => loadConfigData());
    }

    init();

</script>

</body>
</html>
